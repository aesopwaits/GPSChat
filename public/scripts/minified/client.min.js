var InboundEventDomHandler=_.extend({},Backbone.Events);InboundEventDomHandler.off("userLocationFound").on("userLocationFound",function(e){NameEntryView.showStartButton()}),InboundEventDomHandler.off("selfMessage").on("selfMessage",function(e){"undefined"!=typeof e.ImageUrl?ChatView.chatWindowPartial.addImageMessage(e,"message","myNameMessage"):ChatView.chatWindowPartial.addMessage(e,"message","myNameMessage")}),InboundEventDomHandler.off("message").on("message",function(e){"undefined"!=typeof e.ImageUrl?ChatView.chatWindowPartial.addImageMessage(e,"message","userNameMessage"):ChatView.chatWindowPartial.addMessage(e,"message","userNameMessage"),ChatView.updateTitle()}),InboundEventDomHandler.off("injectMessage").on("injectMessage",function(e){ChatView.chatWindowPartial.addMessage(e,"roomMessage","")}),InboundEventDomHandler.off("title").on("title",function(e){ChatView.displayChatTemplate(e)}),InboundEventDomHandler.off("joined").on("joined",function(e){ChatView.chatWindowPartial.addMessage(e+" has joined","roomMessage","")}),InboundEventDomHandler.off("selfjoined").on("selfjoined",function(e){console.log("You have joined"),ChatView.chatWindowPartial.addMessage("You have joined the room '"+e+"'","roomMessage","")}),InboundEventDomHandler.off("left").on("left",function(e){ChatView.chatWindowPartial.addMessage(e+" has left the room","roomMessage","")}),InboundEventDomHandler.off("selfLeft").on("selfLeft",function(e){ChatView.chatWindowPartial.addMessage("You left the room "+e,"roomMessage","")}),InboundEventDomHandler.off("usersInRoomUpdate").on("usersInRoomUpdate",function(e){ChatView.memberListPartial.refreshUserList(e)}),InboundEventDomHandler.off("userError").on("userError",function(e){ChatView.displayUserError(e)}),InboundEventDomHandler.off("messageHistory").on("messageHistory",function(e){e.forEach(function(t){"undefined"!=typeof e.ImageUrl?ChatView.chatWindowPartial.addImageMessage(t,"missedMessage","userNameMissedMessage",t.Timestamp):ChatView.chatWindowPartial.addMessage(t,"missedMessage","userNameMissedMessage",t.Timestamp)})}),InboundEventDomHandler.off("userBooted").on("userBooted",function(e){ChatView.chatWindowPartial.addMessage("You have been booted from the room","roomMessage",""),ChatView.disconnectTime=Date.now(),ChatView.displayNameEntryTemplate()}),InboundEventDomHandler.off("typing").on("typing",function(e){ChatView.chatWindowPartial.startedTyping(e)}),InboundEventDomHandler.unbind("stopTyping").on("stopTyping",function(e){ChatView.chatWindowPartial.stoppedTyping(e)}),InboundEventDomHandler.unbind("weather").on("weather",function(e){ChatView.chatWindowPartial.setWeather(e),setTimeout(function(){OutboundEventHandler.trigger("getWeather")},6e4)});var OutboundEventHandler=_.extend({},Backbone.Events);OutboundEventHandler.registerOutboundEvents=function(e){OutboundEventHandler.off("sendMessage").on("sendMessage",function(t){e.emit("message",t,Date.now())}),OutboundEventHandler.off("leave").on("leave",function(){e.emit("leave")}),OutboundEventHandler.off("bootUser").on("bootUser",function(t){e.emit("bootUser",t)}),OutboundEventHandler.off("notifyTyping").on("notifyTyping",function(){e.emit("notifyTyping",NameEntryView.userName)}),OutboundEventHandler.off("stoppedTyping").on("stoppedTyping",function(){e.emit("stoppedTyping",NameEntryView.userName)}),OutboundEventHandler.off("getWeather").on("getWeather",function(){e.emit("getWeather")}),OutboundEventHandler.off("connect").on("connect",function(){e.emit("getWeather")})};var SocketHandler=function(){var e=io.connect(window.location.protocol+"//"+window.location.hostname+":3000",{forceNew:!0}),t="",a=!1;return{errorCallback:function(e){1==e.code?alert("Error: Access is denied!"):2==e.code&&alert("Error: Position is unavailable!")},determineLocationAndEstablishSocketConnection:function(e){navigator.geolocation.getCurrentPosition(function(a){t=a,e()},this.errorCallback,{timeout:1e4})},connectToChatRoom:function(n){var s=this;this.getServerEventNames(function(i){0==a&&(s.fireBackboneEventsOnInboundSocketEvents(i),OutboundEventHandler.registerOutboundEvents(e)),e.emit("enterChatRoom",{UserName:NameEntryView.userName,Lat:t.coords.latitude,Lon:t.coords.longitude,TimeDisconnected:n})})},getServerEventNames:function(e){var t=[];$.getJSON("/events",function(a){for(var n in a)a.hasOwnProperty(n)&&t.push(a[n]);e(t)})},fireBackboneEventsOnInboundSocketEvents:function(t){t.forEach(function(t){e.removeAllListeners(t).on(t,function(e){InboundEventDomHandler.trigger(t,e)})}),a=!0}}};ChatWindowPartial=Backbone.View.extend({el:"#chatTemplate",initialize:function(){this.showTimestamps=!1,this.messTimestampPartial="",this.messagePartial="",this.imageMessagePartial="",this.typingTimeout="",this.renderTemplates()},events:{"click #timestampChkBox":"toggleTimestamps","DOMSubtreeModified #chatlog":"autoScroll","keypress #msgbox":"handleMessageBox","keyup #msgbox":"checkForFlags","click #btnDisconnect":"handleDisconnect"},renderTemplates:function(){var e=this;$.get("/templates/ChatTemplate.html",function(t){template=_.template(t,{}),e.$el.html(template)},"html"),$.get("/templates/partials/Timestamp.html",function(t){e.messTimestampPartial=t},"html"),$.get("/templates/partials/Message.html",function(t){e.messagePartial=t},"html"),$.get("/templates/partials/ImageMessage.html",function(t){e.imageMessagePartial=t},"html")},addMessage:function(e,t,a,n){var s=$("#chatlog"),i=this.showTimestamps?"showTimestamp":"hideTimestamp",o=n?new Date(n).toString("hh:mm tt"):(new Date).toString("hh:mm tt"),r=_.template(this.messTimestampPartial)({timeStamp:o,toggleTimestampClass:i}),m="";"undefined"!=typeof e&&"undefined"!=typeof e.Content?(e.Content=e.Content.replace(/^[^:]*:/,""),m=_.template(this.messagePartial)({timeStamp:r,userClass:a,userName:e.User,messageText:e.Content,messageClass:t}),"userNameMessage"==a&&$("#chkBoxSounds").is(":checked")&&$("#newMessageSound").get(0).play()):m=_.template(this.messagePartial)({timeStamp:"",userClass:"",userName:"",messageText:r+e,messageClass:t}),s.append(m)},addImageMessage:function(e,t,a,n){var s=$("#chatlog"),i=this.showTimestamps?"showTimestamp":"hideTimestamp",o=n?new Date(n).toString("hh:mm tt"):(new Date).toString("hh:mm tt"),r=_.template(this.messTimestampPartial)({timeStamp:o,toggleTimestampClass:i}),m=_.template(this.imageMessagePartial)({timeStamp:r,userClass:a,userName:e.User,messageClass:t,url:e.ImageUrl});s.append(m),"userNameMessage"==a&&$("#chkBoxSounds").is(":checked")&&$("#newMessageSound").get(0).play()},addLightMessage:function(e,t,a,n){var s=$("#chatlog"),i=this.showTimestamps?"showTimestamp":"hideTimestamp",o=n?'<div class="timestamp '+i+'">'+new Date(n).toString("hh:mm tt")+" </div>":'<div class="timestamp '+i+'">'+(new Date).toString("hh:mm tt")+" </div>";s.append('<div class="'+a+'">'+o+e.User+'<div class="'+t+'">'+e.StateMessage+"</div></div>"),"userNameMessage"==a&&$("#chkBoxSounds").is(":checked")&&$("#newMessageSound").get(0).play()},autoScroll:function(){var e=$("#chatlog");e.animate({scrollTop:e.get(0).scrollHeight},1)},checkForFlags:function(){var e=$("#msgbox");0==e.val().indexOf("/img")||0==e.val().indexOf("/lights")?e.addClass("specialCommand"):e.removeClass("specialCommand")},handleDisconnect:function(){OutboundEventHandler.trigger("leave"),ChatView.disconnectTime=Date.now(),ChatView.displayNameEntryTemplate()},handleMessageBox:function(e){"13"==e.which?(this.sendMsg(),e.preventDefault()):(clearTimeout(this.typingTimeout),OutboundEventHandler.trigger("notifyTyping"),this.typingTimeout=setTimeout(function(){OutboundEventHandler.trigger("stoppedTyping",NameEntryView.userName)},500))},sendMsg:function(){var e=$("#msgbox"),t=e.val();OutboundEventHandler.trigger("sendMessage",NameEntryView.userName+": "+t),e.val("")},setWeather:function(e){$("#weather").html('Current weather: <div class="weatherData">'+e.Weather+" "+e.Temp+"</div>")},startedTyping:function(e){var t=$("#memberList").find("div").filter(':contains("'+e+'")').children().first();t.removeClass("hidetyping"),t.addClass("typing")},stoppedTyping:function(e){var t=$("#memberList").find("div").filter(':contains("'+e+'")').children().first();t.addClass("hidetyping"),t.removeClass("typing")},toggleTimestamps:function(){var e=$(".timestamp");e.is(":visible")?(e.removeClass("showTimestamp"),e.addClass("hideTimestamp"),$("#timestampChkBox").val("Show Timestamps"),this.showTimestamps=!1):(e.removeClass("hideTimestamp"),e.addClass("showTimestamp"),$("#timestampChkBox").val("Hide Timestamps"),this.showTimestamps=!0)}}),MemberListPartial=Backbone.View.extend({el:"#chatTemplate",initialize:function(){var e=this;this.newMemberPartial="",this.socketIDPartial="",$.get("/templates/partials/NewMember.html",function(t){e.newMemberPartial=t},"html"),$.get("/templates/partials/MemberSocketID.html",function(t){e.socketIDPartial=t},"html")},events:{"click .memberName":"handleBoot"},addMember:function(e){var t=_.template(this.newMemberPartial)({memberName:e});$("#memberList").append(t)},handleBoot:function(e){var t=$(e.currentTarget).next();OutboundEventHandler.trigger("bootUser",{UserName:t.attr("id"),SocketID:t.html()})},refreshUserList:function(e){var t=this,a=$("#memberList");a.html(""),$.each(e,function(e,n){t.addMember(n.Name);var s=_.template(t.socketIDPartial)({memberName:n.Name,socketID:n.SocketID});a.append(s)})}}),ChatView=Backbone.View.extend({el:"#chatTemplate",initialize:function(){this.messageCount=0,this.disconnectTime=Date.now(),this.render(),this.memberListPartial=new MemberListPartial,this.chatWindowPartial=new ChatWindowPartial},render:function(){var e=this;$(window).on("focus",function(){document.title="Yosaaaa.ly",e.messageCount=0})},displayChatTemplate:function(e){$("#txtUserName").blur(),$("#userTemplate").hide(),$("h2").html('<div class="title">Current Room </div>'+e),$("#chatTemplate").show(),$("#msgbox").focus()},displayNameEntryTemplate:function(){$("#chatTemplate").hide(),$("#userTemplate").show(),$("#btnSendUser,#txtUserName").prop("disabled",!1)},displayUserError:function(e){this.displayNameEntryTemplate(),$("#userExistsError").show().html(e),$("#txtUserName").removeClass("valid").addClass("invalid")},updateTitle:function(){document.hasFocus()||(this.messageCount++,document.title="Yosaaaa.ly ("+this.messageCount+")")}});var ChatView=new ChatView;NameEntryView=Backbone.View.extend({el:"#userTemplate",initialize:function(){this.userName="",this.socketHandler=new SocketHandler,this.render()},render:function(){var e=this;$.get("/templates/NameEntryTemplate.html",function(t){template=_.template(t,{}),e.$el.html(template),e.socketHandler.determineLocationAndEstablishSocketConnection(function(){e.readyToEnterChat()})},"html")},events:{"focus #txtUserName":"hideErrors","keypress #txtUserName":"startChat","click #btnSendUser":"startChat"},readyToEnterChat:function(){$("#entryLoader").hide(),$("#txtUserName").show(),$("#btnSendUser").show()},hideErrors:function(){$("#error").hide(),$("#userExistsError").hide(),$("#txtUserName").removeClass("invalid").addClass("valid")},startChat:function(e){if(this.hideErrors(),"undefined"!=typeof e&&("13"==e.which||"click"==e.type)){e.preventDefault();var t=$("#txtUserName"),a=t.val();a&&/\S/.test(a)?($("#btnSendUser,#txtUserName").prop("disabled",!0),this.userName=a,t.removeClass("invalid").addClass("valid"),this.socketHandler.connectToChatRoom(ChatView.disconnectTime)):($("#error").show(),t.removeClass("valid").addClass("invalid"))}}});var NameEntryView=new NameEntryView;